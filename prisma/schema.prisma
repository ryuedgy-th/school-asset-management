// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// 13. Departments
model Department {
  id          Int      @id @default(autoincrement())
  code        String   @unique // "IT", "FM", "STATIONARY"
  name        String // "IT Department", "Facility Management"
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  users       User[]
  roles       Role[]
  assets      Asset[]
  inspections Inspection[]
}

// 14. Users & Permissions
model User {
  id             Int         @id @default(autoincrement())
  name           String?
  nickname       String?     // Thai nickname for common use
  email          String?     @unique
  emailVerified  DateTime?
  image          String?
  password       String?
  
  // Role and Department (optional for initial SSO signup)
  roleId         Int?
  userRole       Role?       @relation(fields: [roleId], references: [id])
  departmentId   Int?
  userDepartment Department? @relation(fields: [departmentId], references: [id])
  phoneNumber    String?

  // Account Lockout
  failedLoginAttempts Int       @default(0)
  lockedUntil         DateTime?
  lastLoginAttempt    DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt

  accounts Account[]
  sessions Session[]
  logs     AuditLog[]

  // Relations
  assignments           Assignment[]        @relation
  closedAssignments     Assignment[]        @relation("ClosedAssignments")
  checkedReturns        ReturnTransaction[] @relation("CheckedReturns")
  createdTransactions   BorrowTransaction[]
  cancelledTransactions BorrowTransaction[] @relation("CancelledTransactions")
  assignedTasks         PMTask[]
  inspections           Inspection[]        @relation("InspectorInspections")
  approvedInspections   Inspection[]        @relation("InspectionApprover")

  // FM Asset Management Relations
  createdFMAssets       FMAsset[]              @relation("FMAssetCreatedBy")
  assignedPMSchedules   PMSchedule[]
  reportedTickets       Ticket[]               @relation("TicketReporter")
  affectedTickets       Ticket[]               @relation("AffectedTickets")
  assignedTickets       Ticket[]               @relation("TicketAssignee")
  ticketComments        TicketComment[]
  ticketAttachments     TicketAttachment[]
  ticketActivities      TicketActivity[]
  inventoryTransactions InventoryTransaction[]
  inspectionRecords     ACInspectionRecord[]
}

// ============================================
// 14.1 RBAC: Module Registry
// ============================================
model Module {
  id          Int      @id @default(autoincrement())
  code        String   @unique // "assets", "pm_schedules", "tickets"
  name        String // "IT Assets", "PM Schedules", "Tickets"
  description String?
  category    String? // "IT", "FM", "STATIONARY", "System"
  icon        String? // Icon name for UI (lucide-react icon name)
  routePath   String? // "/assets", "/pm-schedules" (for navigation)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0) // For UI ordering
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions ModulePermission[]

  @@index([category])
  @@index([isActive])
}

// ============================================
// 14.2 RBAC: Module Permission Templates
// ============================================
model ModulePermission {
  id          Int    @id @default(autoincrement())
  moduleId    Int
  module      Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)

  action      String // "view", "create", "edit", "delete", "approve", "export"
  name        String // "View Assets", "Create Assets", "Delete Assets"
  description String? // Detailed description of what this permission allows

  rolePermissions RolePermission[]

  @@unique([moduleId, action])
  @@index([moduleId])
}

// ============================================
// 14.3 RBAC: Role Permissions (Junction Table)
// ============================================
model RolePermission {
  id           Int              @id @default(autoincrement())
  roleId       Int
  role         Role             @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permissionId Int
  permission   ModulePermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  // Optional: Scope filters (stored as JSON)
  // Example: { "departmentOnly": true, "ownOnly": false, "categories": ["hardware"] }
  scopeFilter String? // JSON string for additional filters

  createdAt DateTime @default(now())

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
}

model Role {
  id           Int         @id @default(autoincrement())
  name         String
  description  String?     // Role description for UI
  departmentId Int?        // null = cross-department (Admin, Executive)
  department   Department? @relation(fields: [departmentId], references: [id])
  scope        String      @default("department") // "department", "cross-department", "global"
  isActive     Boolean     @default(true)
  isSystem     Boolean     @default(false) // NEW: Built-in roles (cannot be deleted)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  users           User[]
  rolePermissions RolePermission[] // NEW: Link to new permission system

  @@unique([name, departmentId])
}

model AuditLog {
  id        Int      @id @default(autoincrement())
  action    String // CREATE, UPDATE, DELETE, LOGIN
  entity    String // User, Asset, Role
  entityId  String // ID of the entity affected
  details   String? // JSON string of changes
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model LoginAttempt {
  id        Int      @id @default(autoincrement())
  email     String
  ipAddress String
  createdAt DateTime @default(now())
}

model Account {
  id                Int     @id @default(autoincrement())
  userId            Int
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           Int      @id @default(autoincrement())
  sessionToken String   @unique
  userId       Int
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  @@unique([identifier, token])
}

// Assets (Equipment)
model Asset {
  id           Int       @id @default(autoincrement())
  name         String
  category     String // Laptop, Tablet, Camera, etc.
  // Enterprise Fields
  assetCode    String    @unique @default(cuid()) // Internal Tracking ID (e.g. AST-2024-001)
  brand        String?
  model        String?
  serialNumber String? // Manufacturer S/N (Non-unique allowed? No, usually distinct, but let's keep unique if possible, or relax it. Existing was unique.)
  purchaseDate DateTime?
  warrantyExp  DateTime?
  vendor       String?
  cost         Decimal?
  location     String?

  status       String  @default("Available") // Available, Reserved, Borrowed, Maintenance, Broken, Lost, Retired
  image        String? // Path to image file
  totalStock   Int     @default(1) // For non-serialized items
  currentStock Int     @default(1)

  // Department (for multi-department isolation)
  departmentId    Int? // null = legacy data (default to IT)
  assetDepartment Department? @relation(fields: [departmentId], references: [id])

  // Relations
  borrowItems  BorrowItem[]
  pmTasks      PMTask[]
  issueReports IssueReport[]
  inspections  Inspection[]
  Ticket       Ticket[]
}

// Asset Inspection Model
model Inspection {
  id               Int      @id @default(autoincrement())
  inspectionNumber String?  @unique // Auto-generated: INS-YYYY-NNN
  assetId          Int
  inspectionDate   DateTime @default(now())
  inspectionType   String // 'checkout', 'checkin', 'periodic', 'incident'
  inspectorId      Int

  // Department (for multi-department isolation)
  departmentId         Int? // null = legacy data (default to IT)
  inspectionDepartment Department? @relation(fields: [departmentId], references: [id])

  // Assignment Link (auto-detected)
  assignmentId Int?

  // Detailed Checklist Fields
  exteriorCondition   String? // 'no_damage', 'minor_wear', 'moderate_wear', 'visible_dent', 'structural_damage', 'other'
  exteriorNotes       String?
  screenCondition     String? // 'perfect', 'minor_scratches', 'noticeable_scratches', 'screen_blemish', 'cracked', 'other'
  screenNotes         String?
  buttonPortCondition String? // 'all_functional', 'sticky_button', 'loose_port', 'non_functional', 'other'
  buttonPortNotes     String?
  keyboardCondition   String? // 'fully_functional', 'minor_wear', 'sticking_keys', 'missing_keys', 'not_applicable', 'other'
  keyboardNotes       String?
  touchpadCondition   String? // 'fully_functional', 'inconsistent', 'non_functional', 'not_applicable'
  batteryHealth       String? // 'normal', 'moderate', 'replace_soon', 'not_applicable'

  // Overall Assessment (Auto-computed or manual)
  overallCondition  String // 'excellent', 'good', 'fair', 'poor', 'broken'
  damageFound       Boolean  @default(false)
  damageDescription String?
  estimatedCost     Decimal? @default(0)

  // Photos (JSON array of paths)
  photoUrls String? // JSON array: ["path1.jpg", "path2.jpg"]

  // Email Tracking
  emailSent   Boolean   @default(false)
  emailSentAt DateTime?

  // PDF Tracking
  acknowledgementPdfGenerated Boolean @default(false)
  acknowledgementPdfPath      String?

  // Workflow Status (for damage management)
  damageStatus String? @default("pending_review")
  // Values: pending_review, quotation_received, approved, form_sent, completed, waived

  // Damage Severity (for repair tracking)
  damageSeverity String? // 'minor', 'moderate', 'severe'
  canContinueUse Boolean @default(false) // Can asset still be used despite damage

  // Repair Tracking
  repairStatus        String? // 'pending', 'in_progress', 'completed', 'cannot_repair'
  repairStartDate     DateTime?
  repairCompletedDate DateTime?
  repairCost          Decimal?
  repairNotes         String?
  repairedBy          String? // Technician/Vendor name

  // Approval Tracking
  approvedBy    Int?
  approvedAt    DateTime?
  approvalNotes String?

  // Form Tracking
  formSentAt   DateTime?
  formSignedAt DateTime?

  // Additional Notes
  notes String?

  createdAt DateTime @default(now())

  // Relations
  asset      Asset       @relation(fields: [assetId], references: [id])
  inspector  User        @relation(name: "InspectorInspections", fields: [inspectorId], references: [id])
  assignment Assignment? @relation(fields: [assignmentId], references: [id])
  approver   User?       @relation(name: "InspectionApprover", fields: [approvedBy], references: [id])

  // Reverse relations
  checkoutBorrowItems BorrowItem[]        @relation("ItemCheckoutInspection")
  checkinTransactions ReturnTransaction[] @relation("CheckinInspection")
  ticket              Ticket? // One inspection can create one ticket
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// New Model for Issue Reporting (QR Scan Flow)
model IssueReport {
  id           Int      @id @default(autoincrement())
  assetId      Int
  reporterName String? // Mobile user might be anonymous or guest
  description  String
  status       String   @default("Open") // Open, Ack, Resolved
  createdAt    DateTime @default(now())

  asset Asset @relation(fields: [assetId], references: [id])
}

// 9. Equipment Borrowing
// 9. Equipment Borrowing (Enhanced)
model Assignment {
  id               Int       @id @default(autoincrement())
  assignmentNumber String    @unique // e.g. AS-2024-001
  userId           Int
  academicYear     String // "2024"
  term             Int // 1 or 2 (Term 1, Term 2)
  status           String    @default("Active") // Active, Closed
  createdAt        DateTime  @default(now())
  closedAt         DateTime?

  // IT Closure (when closing assignment at year-end)
  itClosureSignature String? // Path to IT signature image
  closedById         Int? // IT staff who closed it
  closureNotes       String? // Optional notes when closing

  user               User                @relation(fields: [userId], references: [id])
  closedBy           User?               @relation(name: "ClosedAssignments", fields: [closedById], references: [id])
  borrowTransactions BorrowTransaction[]
  returnTransactions ReturnTransaction[]
  inspections        Inspection[]

  // Public Signature Link (for assignments)
  signatureToken       String?   @unique
  signatureTokenExpiry DateTime?
  signedPdfPath        String? // Path to signed PDF
}

model BorrowTransaction {
  id                Int      @id @default(autoincrement())
  assignmentId      Int
  transactionNumber String   @unique // e.g. TR-2024-001
  borrowDate        DateTime @default(now())
  
  // Transaction Status Tracking
  status            String   @default("pending") // pending, active, cancelled, completed
  
  // Cancellation Metadata (for audit trail)
  cancelledAt       DateTime?
  cancelledById     Int?
  cancelReason      String?
  
  borrowerSignature String? // Path to image
  notes             String?
  createdById       Int

  // Signature token fields
  signatureToken       String?   @unique
  signatureTokenExpiry DateTime?
  isSigned             Boolean   @default(false)
  signedAt             DateTime?

  // PDF Receipt
  signedPdfPath        String?
  signedPdfGeneratedAt DateTime?

  assignment  Assignment   @relation(fields: [assignmentId], references: [id])
  createdBy   User         @relation(fields: [createdById], references: [id])
  cancelledBy User?        @relation("CancelledTransactions", fields: [cancelledById], references: [id])
  items       BorrowItem[]
  
  @@index([status])
  @@index([assignmentId])
}

model BorrowItem {
  id                  Int    @id @default(autoincrement())
  borrowTransactionId Int
  assetId             Int
  quantity            Int    @default(1)
  status              String @default("Borrowed") // Reserved, Borrowed, Returned, Cancelled

  // Inspection at checkout (per-asset)
  checkoutInspectionId Int?
  checkoutInspection   Inspection? @relation("ItemCheckoutInspection", fields: [checkoutInspectionId], references: [id])

  borrowTransaction BorrowTransaction @relation(fields: [borrowTransactionId], references: [id])
  asset             Asset             @relation(fields: [assetId], references: [id])
  returnItems       ReturnItem[]
}

model ReturnTransaction {
  id               Int      @id @default(autoincrement())
  assignmentId     Int
  returnDate       DateTime @default(now())
  checkedById      Int
  checkerSignature String? // Path to image
  notes            String?

  // Inspection at checkin
  checkinInspectionId Int?
  checkinInspection   Inspection? @relation("CheckinInspection", fields: [checkinInspectionId], references: [id])

  assignment Assignment   @relation(fields: [assignmentId], references: [id])
  checkedBy  User         @relation(name: "CheckedReturns", fields: [checkedById], references: [id])
  items      ReturnItem[]
}

model ReturnItem {
  id                  Int      @id @default(autoincrement())
  returnTransactionId Int
  borrowItemId        Int
  condition           String // Good, Damaged, Lost
  damageNotes         String?
  damageCharge        Decimal? @default(0)
  quantity            Int      @default(1)

  returnTransaction ReturnTransaction @relation(fields: [returnTransactionId], references: [id])
  borrowItem        BorrowItem        @relation(fields: [borrowItemId], references: [id])
}

// 10. Preventive Maintenance (PM)
model PMTask {
  id            Int      @id @default(autoincrement())
  title         String
  description   String?
  scheduledDate DateTime
  status        String   @default("Pending") // Pending, Completed, Overdue
  type          String // Infrastructure, Hardware, Network, AV
  assetId       Int?
  assigneeId    Int?
  resultNotes   String?
  resultImage   String?

  asset    Asset? @relation(fields: [assetId], references: [id])
  assignee User?  @relation(fields: [assigneeId], references: [id])
}

// 11. Domains
model Domain {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  registrar       String?
  expiryDate      DateTime
  sslStatus       String? // Active, Warning, Expired
  sslExpiry       DateTime?
  autoRenew       Boolean   @default(false)
  hostingProvider String?
}

// 12. Software Licenses
model License {
  id           Int       @id @default(autoincrement())
  softwareName String
  licenseKey   String?
  type         String // Subscription, Perpetual
  seatsTotal   Int
  seatsUsed    Int       @default(0)
  expiryDate   DateTime?
  cost         String?
  vendor       String?
}

// 13. Contracts
model Contract {
  id        Int      @id @default(autoincrement())
  title     String
  partner   String // Company Name
  type      String // Lease, Service, MA
  startDate DateTime
  endDate   DateTime
  value     String?
  status    String   @default("Active")
  filePath  String? // Path to PDF
}

// Email Management System
model EmailAccount {
  id        Int     @id @default(autoincrement())
  name      String // Display name (e.g., "IT Department", "Admin")
  email     String  @unique
  type      String // "SMTP" or "GOOGLE_OAUTH"
  isDefault Boolean @default(false)
  isActive  Boolean @default(true)

  // SMTP fields
  smtpHost     String?
  smtpPort     Int?
  smtpUser     String?
  smtpPassword String? // Encrypted
  smtpSecure   Boolean @default(true)

  // OAuth2 fields (for Google OAuth)
  oauthClientId     String? // Google OAuth Client ID
  oauthClientSecret String? // Encrypted
  oauthRefreshToken String? // Encrypted (long-lived)
  oauthAccessToken  String? // Encrypted (short-lived)
  oauthTokenExpiry  DateTime? // When access token expires

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  templates EmailTemplate[]
}

model EmailTemplate {
  id        Int    @id @default(autoincrement())
  name      String // "Inspection Complete", "Borrow Request"
  subject   String
  body      String // Template with variables like {userName}, {assetName}
  variables String // JSON array of available variables
  category  String // "inspection", "borrowing", "general"

  emailAccountId Int?
  emailAccount   EmailAccount? @relation(fields: [emailAccountId], references: [id])

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 14. System Settings
model SystemSettings {
  id        Int      @id @default(autoincrement())
  key       String   @unique // e.g. "smtp_host", "smtp_port"
  value     String? // Encrypted for sensitive values
  category  String   @default("general") // general, email, security
  isSecret  Boolean  @default(false) // If true, value is encrypted
  updatedAt DateTime @default(now()) @updatedAt
  updatedBy Int?
}

// 15. Notification Recipients
model NotificationRecipient {
  id            Int      @id @default(autoincrement())
  category      String // "inspection", "damage_approval", "damage_waiver", "assignment_signature"
  recipientType String // "to", "cc", "bcc", "reply_to"
  role          String // "director", "it_head", "department_head", "inspector", "user"
  email         String? // null = dynamic (e.g., inspector's email from inspection record)
  name          String? // Display name
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([category, isActive])
}

// ============================================================
// FM ASSET MANAGEMENT SYSTEM
// ============================================================

// 16. FM Asset Categories
model FMAssetCategory {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  icon        String? // Icon name for UI
  color       String? // Color code for UI
  assets      FMAsset[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// 17. FM Assets (Facilities, Vehicles, Equipment)
model FMAsset {
  id          Int     @id @default(autoincrement())
  assetCode   String  @unique
  name        String
  description String?

  // Category
  categoryId Int
  category   FMAssetCategory @relation(fields: [categoryId], references: [id])

  // Type & Details
  type         String? // "Air Conditioner", "Vehicle", "Generator"
  brand        String?
  model        String?
  serialNumber String?

  // Location
  location String?
  building String?
  floor    String?
  room     String?

  // Dates
  purchaseDate   DateTime?
  installDate    DateTime?
  warrantyExpiry DateTime?

  // Specifications (JSON for flexibility)
  specifications String? // { "capacity": "24000 BTU", "voltage": "220V" }

  // Condition
  condition String @default("good") // "excellent", "good", "fair", "poor"
  status    String @default("active") // "active", "inactive", "maintenance", "retired"

  // Maintenance
  requiresMaintenance Boolean @default(false) // true = needs PM, false = no PM (furniture)

  // Hierarchy (Parent-Child)
  parentAssetId Int?
  parentAsset   FMAsset?  @relation("AssetHierarchy", fields: [parentAssetId], references: [id], onDelete: Restrict)
  childAssets   FMAsset[] @relation("AssetHierarchy")

  // Cost
  purchaseCost Decimal?
  currentValue Decimal?

  // Images & QR
  images String? // Array of image URLs
  qrCode String? @unique

  // Relations
  components        AssetComponent[]
  pmSchedules       PMSchedule[]
  maintenanceLogs   MaintenanceLog[]
  tickets           Ticket[]
  inspectionRecords ACInspectionRecord[]

  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdById Int?
  createdBy   User?    @relation("FMAssetCreatedBy", fields: [createdById], references: [id])

  @@index([categoryId])
  @@index([status])
  @@index([location])
}

// 18. Asset Components (Parts of an asset)
model AssetComponent {
  id      Int     @id @default(autoincrement())
  assetId Int
  asset   FMAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  name          String // "Compressor", "Air Filter", "Engine"
  componentType String // "Mechanical", "Electrical", "Electronic"
  description   String?

  // Identification
  serialNumber String?
  partNumber   String?
  manufacturer String?
  model        String?

  // Installation
  installDate DateTime?
  installedBy String?

  // Service
  lastServiceDate DateTime?
  nextServiceDue  DateTime?
  serviceInterval Int? // Days

  // Lifecycle
  expectedLifespan Int? // Months
  replacementCost  Decimal?

  // Condition
  condition String @default("good")
  status    String @default("active")

  // Notes
  notes String?

  // Relations
  serviceHistory ComponentService[]
  spareParts     ComponentSparePart[]
  pmSchedules    PMSchedule[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetId])
}

// 19. Component Service History
model ComponentService {
  id          Int            @id @default(autoincrement())
  componentId Int
  component   AssetComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)

  serviceDate DateTime
  serviceType String // "inspection", "cleaning", "repair", "replacement"
  description String
  performedBy String

  cost          Decimal?
  partsReplaced String?

  nextServiceDue DateTime?

  createdAt DateTime @default(now())

  @@index([componentId])
  @@index([serviceDate])
}

// 20. PM Schedules
model PMSchedule {
  id      Int     @id @default(autoincrement())
  assetId Int
  asset   FMAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  // Optional: PM Schedule for specific component
  componentId Int?
  component   AssetComponent? @relation(fields: [componentId], references: [id], onDelete: Cascade)

  name        String
  description String?

  // Schedule Type
  scheduleType String // "time", "usage", "condition"

  // Time-Based
  frequency     String? // "daily", "weekly", "monthly", "quarterly", "yearly"
  intervalValue Int? // e.g., 2 for "every 2 weeks"
  intervalUnit  String? // "days", "weeks", "months", "years"

  // Usage-Based
  usageMetric   String? // "km", "hours", "cycles"
  usageInterval Int?

  // Next Due
  lastPerformed DateTime?
  nextDueDate   DateTime?
  nextDueUsage  Int?

  // Checklist
  checklistItems String? // [{ "task": "Clean filter", "required": true }]

  // Work Order Settings
  autoCreateWO Boolean @default(true)
  leadTimeDays Int     @default(7)
  priority     String  @default("medium")

  // Assignment
  assignedToId Int?
  assignedTo   User? @relation(fields: [assignedToId], references: [id])

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([assetId])
  @@index([componentId])
  @@index([nextDueDate])
}

// 21. Unified Ticket System (IT + FM)
model Ticket {
  id           Int    @id @default(autoincrement())
  ticketNumber String @unique // "IT-2024-001", "FM-2024-001"

  // Type & Category
  type        String // "IT", "FM"
  category    String // "Hardware", "HVAC", "Vehicle", etc.
  subCategory String? // "AC Maintenance", "Laptop Repair"

  // Asset Reference
  itAssetId Int?
  itAsset   Asset? @relation(fields: [itAssetId], references: [id])

  fmAssetId Int?
  fmAsset   FMAsset? @relation(fields: [fmAssetId], references: [id])

  // Inspection Link (if ticket was created from inspection)
  inspectionId Int?      @unique // One inspection = one ticket
  inspection   Inspection? @relation(fields: [inspectionId], references: [id])

  // Ticket Details
  title       String
  description String
  priority    String @default("medium") // "low", "medium", "high", "urgent"
  status      String @default("open") // "open", "assigned", "in_progress", "resolved", "closed"

  // Assignment
  reportedById Int
  reportedBy   User @relation("TicketReporter", fields: [reportedById], references: [id])

  affectedUserId Int? // User affected by this issue (e.g., teacher reporting via helpdesk)
  affectedUser   User? @relation("AffectedTickets", fields: [affectedUserId], references: [id])

  assignedToId Int?
  assignedTo   User? @relation("TicketAssignee", fields: [assignedToId], references: [id])

  // Dates
  reportedAt DateTime  @default(now())
  assignedAt DateTime?
  resolvedAt DateTime?
  closedAt   DateTime?

  // Resolution
  resolution      String?
  resolutionNotes String?

  // SLA Tracking
  slaDeadline DateTime?
  slaStatus   String? // within_sla, at_risk, breached

  // Cost Tracking
  actualCost Decimal? // Actual repair cost

  // Attachments
  images    String? // Array of image URLs
  documents String?

  // Relations
  comments    TicketComment[]
  activities  TicketActivity[]
  attachments TicketAttachment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([itAssetId])
  @@index([fmAssetId])
  @@index([inspectionId])
  @@index([reportedById])
  @@index([assignedToId])
  @@index([affectedUserId])
  @@index([slaStatus])
  @@index([slaDeadline])
}

// 22. Ticket Comments
model TicketComment {
  id       Int    @id @default(autoincrement())
  ticketId Int
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  userId Int
  user   User @relation(fields: [userId], references: [id])

  comment String
  images  String?

  createdAt DateTime @default(now())

  @@index([ticketId])
}

// 22b. Ticket Attachments
model TicketAttachment {
  id       Int    @id @default(autoincrement())
  ticketId Int
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  filename     String
  originalName String
  mimeType     String
  size         Int      // in bytes
  url          String

  uploadedById Int
  uploadedBy   User @relation(fields: [uploadedById], references: [id])

  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([uploadedById])
}

// 23. Ticket Activity Log
model TicketActivity {
  id       Int    @id @default(autoincrement())
  ticketId Int
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  userId Int?
  user   User? @relation(fields: [userId], references: [id])

  action  String // "created", "assigned", "status_changed", "commented"
  details String? // { "from": "open", "to": "in_progress" }

  createdAt DateTime @default(now())

  @@index([ticketId])
}

// 24. Spare Parts
model SparePart {
  id          Int     @id @default(autoincrement())
  partNumber  String  @unique
  name        String
  description String?
  category    String // "Filter", "Belt", "Oil", "Refrigerant", "Tire"

  // Supplier
  supplier       String?
  supplierPartNo String?
  unitCost       Decimal?

  // Inventory
  currentStock Int @default(0)
  minStock     Int @default(0)
  maxStock     Int @default(0)
  reorderPoint Int @default(0)

  // Unit
  unit String // "piece", "liter", "kg", "meter"

  // Location
  storageLocation String?
  binLocation     String?

  // Status
  isActive Boolean @default(true)

  // Relations
  components   ComponentSparePart[]
  transactions InventoryTransaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category])
  @@index([currentStock])
}

// 25. Link Components to Spare Parts
model ComponentSparePart {
  id          Int            @id @default(autoincrement())
  componentId Int
  component   AssetComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)

  sparePartId Int
  sparePart   SparePart @relation(fields: [sparePartId], references: [id], onDelete: Cascade)

  quantity      Int     @default(1)
  isRecommended Boolean @default(true)
  notes         String?

  @@unique([componentId, sparePartId])
}

// 26. Inventory Transactions
model InventoryTransaction {
  id          Int       @id @default(autoincrement())
  sparePartId Int
  sparePart   SparePart @relation(fields: [sparePartId], references: [id])

  type     String // "in", "out", "adjustment"
  quantity Int

  // Reference
  referenceType String? // "work_order", "purchase", "adjustment"
  referenceId   Int?

  // Cost Tracking
  estimatedCost Decimal?
  actualCost    Decimal? // Actual repair cost (replaces finalCost)
  finalCost     Decimal? // Deprecated, use actualCost

  // Stock After Transaction
  stockAfter Int

  notes String?

  performedById Int?
  performedBy   User? @relation(fields: [performedById], references: [id])

  createdAt DateTime @default(now())

  @@index([sparePartId])
  @@index([createdAt])
}

// 27. Maintenance Logs
model MaintenanceLog {
  id      Int     @id @default(autoincrement())
  assetId Int
  asset   FMAsset @relation(fields: [assetId], references: [id], onDelete: Cascade)

  date DateTime @default(now())
  type String // "preventive", "corrective", "inspection"

  performedBy String
  description String

  // Readings (for Condition Monitoring)
  readings String? // { "temperature": 25, "pressure": 120, "vibration": 0.5 }

  // Cost
  cost Decimal?

  // Parts
  partsChanged String?

  // Next Service
  nextServiceDue DateTime?

  // Attachments
  images String?

  createdAt DateTime @default(now())

  @@index([assetId])
  @@index([date])
}

// 28. AC Inspection Template
model ACInspectionTemplate {
  id          Int     @id @default(autoincrement())
  name        String // "Monthly AC Inspection"
  description String?

  checklistItems String // Array of checklist items
  // [
  //   { "id": 1, "item": "และตรวจสอบ", "description": "ทำความสะอาดตัวเครื่องภายนอก..." },
  //   { "id": 2, "item": "ทำความสะอาดแผง", "description": "ปัดฝุ่นทำความสะอาดแผง..." }
  // ]

  isActive Boolean              @default(true)
  records  ACInspectionRecord[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 29. AC Inspection Records
model ACInspectionRecord {
  id Int @id @default(autoincrement())

  fmAssetId Int
  fmAsset   FMAsset @relation(fields: [fmAssetId], references: [id])

  templateId Int
  template   ACInspectionTemplate @relation(fields: [templateId], references: [id])

  inspectionDate DateTime @default(now())
  inspectedById  Int
  inspectedBy    User     @relation(fields: [inspectedById], references: [id])

  // Checklist Results
  checklistResults String // Array of results
  // [
  //   { "itemId": 1, "status": "P", "note": "" },
  //   { "itemId": 2, "status": "A", "note": "พบฝุ่นมาก" }
  // ]

  // Overall
  overallStatus String // "pass", "fail", "needs_attention"
  notes         String?
  images        String?

  // Next Inspection
  nextInspectionDue DateTime?

  createdAt DateTime @default(now())

  @@index([fmAssetId])
  @@index([inspectionDate])
}

// ============================================
// 30. Numbering Configuration
// ============================================
model NumberingConfig {
  id             Int     @id @default(autoincrement())
  module         String  @unique // "assets", "tickets", "inspections", "assignments", "fm_assets"
  prefix         String  // "IT", "TKT", "INS", "ASG", "FM"
  includeYear    Boolean @default(true) // Include year in format
  includeMonth   Boolean @default(false) // Include month in format (YYYY-MM)
  sequenceDigits Int     @default(3) // Number of digits for sequence (e.g., 001, 0001)
  separator      String  @default("-") // Separator character between parts
  resetAnnually  Boolean @default(true) // Reset sequence number each year

  // Current sequence tracking (per year if resetAnnually is true)
  currentYear    Int?    // Track which year we're in
  currentMonth   Int?    // Track which month we're in (if includeMonth is true)
  currentSeq     Int     @default(0) // Current sequence number

  // Example format preview
  exampleOutput  String? // e.g., "IT-2025-001"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([module])
}
